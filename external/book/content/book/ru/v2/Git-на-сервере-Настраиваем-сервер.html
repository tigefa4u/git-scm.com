---
### DO NOT EDIT! Generated by script/update-book2.rb
category: book
section: documentation
subsection: book
sidebar: book
book:
  language_code: ru
  chapter:
    title: Git на сервере
    number: 4
  section:
    title: Настраиваем сервер
    number: 4
    cs_number: '4.4'
    previous: book/ru/v2/Git-на-сервере-Генерация-открытого-SSH-ключа
    next: book/ru/v2/Git-на-сервере-Git-демон
title: Git - Настраиваем сервер
url: "/book/ru/v2/Git-на-сервере-Настраиваем-сервер.html"
---
<h2 id="r_setting_up_server">Настраиваем сервер</h2>
<div class="paragraph">
<p>Давайте рассмотрим настройку доступа по SSH на стороне сервера.
В этом примере мы будем использовать метод <code>authorized_keys</code> для аутентификации пользователей.
Мы подразумеваем, что вы используете стандартный дистрибутив Linux типа Ubuntu.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Примечание</div>
</td>
<td class="content">
<div class="paragraph">
<p>Вместо ручного копирования и установки открытых ключей, многое из описанного ниже может быть автоматизировано за счёт использования команды <code>ssh-copy-id</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Для начала создадим пользователя <code>git</code> и каталог <code>.ssh</code> для этого пользователя:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ sudo adduser git
$ su git
$ cd
$ mkdir .ssh &amp;&amp; chmod 700 .ssh
$ touch .ssh/authorized_keys &amp;&amp; chmod 600 .ssh/authorized_keys</code></pre>
</div>
</div>
<div class="paragraph">
<p>Затем вам нужно добавить открытые SSH-ключи разработчиков в файл <code>authorized_keys</code> пользователя <code>git</code>.
Предположим, у вас уже есть несколько таких ключей и вы сохранили их во временные файлы.
Напомним, открытый ключ выглядит примерно так:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cat /tmp/id_rsa.john.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCB007n/ww+ouN4gSLKssMxXnBOvf9LGt4L
ojG6rs6hPB09j9R/T17/x4lhJA0F3FR1rP6kYBRsWj2aThGw6HXLm9/5zytK6Ztg3RPKK+4k
Yjh6541NYsnEAZuXz0jTTyAUfrtU3Z5E003C4oxOj6H0rfIF1kKI9MAQLMdpGW1GYEIgS9Ez
Sdfd8AcCIicTDWbqLAcU4UpkaX8KyGlLwsNuuGztobF8m72ALC/nLF6JLtPofwFBlgc+myiv
O7TCUSBdLQlgMVOFq1I2uPWQOkOWQAHukEOmfjy2jctxSDBQ220ymjaNsHT4kgtZg2AYYgPq
dAv8JggJICUvax2T9va5 gsg-keypair</code></pre>
</div>
</div>
<div class="paragraph">
<p>Вы просто добавляете их в файл <code>.ssh/authorized_keys</code> в домашнем каталоге пользователя <code>git</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cat /tmp/id_rsa.john.pub &gt;&gt; ~/.ssh/authorized_keys
$ cat /tmp/id_rsa.josie.pub &gt;&gt; ~/.ssh/authorized_keys
$ cat /tmp/id_rsa.jessica.pub &gt;&gt; ~/.ssh/authorized_keys</code></pre>
</div>
</div>
<div class="paragraph">
<p>Теперь вы можете создать пустой репозиторий для них, запустив <code>git init</code> с параметром <code>--bare</code>, что инициализирует репозиторий без рабочего каталога:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cd /srv/git
$ mkdir project.git
$ cd project.git
$ git init --bare
Initialized empty Git repository in /srv/git/project.git/</code></pre>
</div>
</div>
<div class="paragraph">
<p>После этого Джон, Джози или Джессика могут отправить первую версию их проекта в этот репозиторий, добавив его как удалённый и отправив соответствующую ветку.
Заметьте, что кто-то должен заходить на сервер и создавать голый репозиторий каждый раз, когда вы хотите добавить проект.
Пусть <code>gitserver</code> — имя хоста сервера, на котором вы создали пользователя <code>git</code> и репозиторий.
Если он находится в вашей внутренней сети и вы создали DNS запись для <code>gitserver</code>, указывающую на этот сервер, то можно использовать следующие команды как есть (считая что <code>myproject</code> это существующий проект с файлами):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console"># На компьютере Джона
$ cd myproject
$ git init
$ git add .
$ git commit -m 'Initial commit'
$ git remote add origin git@gitserver:/srv/git/project.git
$ git push origin master</code></pre>
</div>
</div>
<div class="paragraph">
<p>Теперь все остальные могут клонировать его и отправлять в него изменения:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clone git@gitserver:/srv/git/project.git
$ cd project
$ vim README
$ git commit -am 'Fix for README file'
$ git push origin master</code></pre>
</div>
</div>
<div class="paragraph">
<p>Этим способом вы можете быстро получить Git-сервер с доступом на чтение/запись для небольшой группы разработчиков.</p>
</div>
<div class="paragraph">
<p>Заметьте, что теперь все эти пользователи могут заходить на сервер как пользователь <code>git</code>.
Чтобы это предотвратить, нужно изменить ему оболочку на что-то другое в файле <code>/etc/passwd</code>.</p>
</div>
<div class="paragraph">
<p>Вы можете легко ограничить пользователя <code>git</code> только действиями, связанными с Git, с помощью ограниченной оболочки <code>git-shell</code>, поставляемой вместе с Git.
Если указать её в качестве командного интерпретатора для пользователя <code>git</code>, то он не сможет получить доступ к обычной командной оболочке на вашем сервере.
Для её использования, укажите <code>git-shell</code> вместо bash или csh для пользователя <code>git</code>.
Для этого вы должны сначала добавить <code>git-shell</code> в <code>/etc/shells</code> если её там ещё нет:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cat /etc/shells   # посмотрим, присутствует ли `git-shell`. Если нет...
$ which git-shell   # проверим, что `git-shell` установлена.
$ sudo -e /etc/shells  # и добавим путь к `git-shell` из предыдущей команды</code></pre>
</div>
</div>
<div class="paragraph">
<p>Теперь можно изменить оболочку для пользователя используя <code>chsh &lt;username&gt; -s &lt;shell&gt;</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ sudo chsh git -s $(which git-shell)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Теперь пользователь <code>git</code> может использовать SSH соединение только для работы с репозиториями Git и не может зайти на машину.
Если вы попробуете войти в систему, то вход будет отклонён:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ ssh git@gitserver
fatal: Interactive git shell is not enabled.
hint: ~/git-shell-commands should exist and have read and execute access.
Connection to gitserver closed.</code></pre>
</div>
</div>
<div class="paragraph">
<p>На текущий момент пользователи всё ещё могут использовать перенаправление порта SSH для доступа к другим Git серверам, к которым текущий может подключиться.
Если это нужно отключить, вы можете добавить следующие опции в файл <code>authorized_keys</code> перед теми ключами, для которых нужно применить это ограничение:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty</code></pre>
</div>
</div>
<div class="paragraph">
<p>В результате файл будет выглядеть следующим образом:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cat ~/.ssh/authorized_keys
no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty ssh-rsa
AAAAB3NzaC1yc2EAAAADAQABAAABAQCB007n/ww+ouN4gSLKssMxXnBOvf9LGt4LojG6rs6h
PB09j9R/T17/x4lhJA0F3FR1rP6kYBRsWj2aThGw6HXLm9/5zytK6Ztg3RPKK+4kYjh6541N
YsnEAZuXz0jTTyAUfrtU3Z5E003C4oxOj6H0rfIF1kKI9MAQLMdpGW1GYEIgS9EzSdfd8AcC
IicTDWbqLAcU4UpkaX8KyGlLwsNuuGztobF8m72ALC/nLF6JLtPofwFBlgc+myivO7TCUSBd
LQlgMVOFq1I2uPWQOkOWQAHukEOmfjy2jctxSDBQ220ymjaNsHT4kgtZg2AYYgPqdAv8JggJ
ICUvax2T9va5 gsg-keypair

no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty ssh-rsa
AAAAB3NzaC1yc2EAAAADAQABAAABAQDEwENNMomTboYI+LJieaAY16qiXiH3wuvENhBG...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Теперь сетевые команды Git будут работать, но пользователи не смогут заходить на сервер.
Вы также можете создать подкаталог в домашнем каталоге пользователя <code>git</code>, чтобы немного изменить поведение <code>git-shell</code>.
Например, вы можете ограничить команды Git, которые сервер будет принимать или сообщение, которое увидят пользователи если попробуют зайти по SSH.
Для получения дополнительной информации по настройке оболочки запустите команду <code>git help shell</code>.</p>
</div>
<div id="nav"><a href="{{< previous-section >}}">prev</a> | <a href="{{< next-section >}}">next</a></div>